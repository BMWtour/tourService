<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet">
    <script crossorigin="anonymous" src="https://kit.fontawesome.com/fdb840a8cc.js"></script>
    <title>Bootstrap demo</title>
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" rel="stylesheet">
</head>
<style>

    /* 지도 크기 설정 */
#map {
    width: 40vw;
    height: 82vh;
}

.map-container {
display: flex;
flex-direction: column;
justify-content: space-between;
width: 48%; /* 두 div 간의 공간을 유지 */
}

body{
    margin: 5vw;
}

a { text-decoration: none; }
.disabled-link { pointer-events: none; }

.row-container {
    position: absolute;
    top: 10vh; /* y 좌표 */
    left: 50vw; /* x 좌표 */
    display: grid;
    gap: 2vh; /* 항목 간 간격 */
}

.row {
border-radius: 1vw;
background-color: #e9e9e9;
background-color: #f0f0f0;
display: grid;
grid-template-columns: 20% 40% 40%;
width: 45vw;
height: 15vh;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
transition-duration: 0.1s;
transition-timing-function: linear;
}

/* 클릭된 항목이 살짝 튀어나오게 하기 */
.row.clicked {
    transform: translateY(-10px); /* 살짝 위로 이동 */
    box-shadow: 0 12px 18px rgba(0, 0, 0, 0.3); /* 강조 효과 */
}

/* 클릭된 항목에 호버 효과 추가 */
.row:hover {
    transform: translateY(-3px); /* 살짝 위로 */
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
}





.img-container{
display: grid;
align-content: center;
justify-items: center;
}
.rightinfo-container, .leftinfo-container{
display:grid;
align-content: space-evenly;
}

.Text{
font-size: 0.8vw;
}

.col{
font-weight: bold;
font-size: 1vw;
}
.rightinfo , .leftinfo {
overflow: hidden; /* 넘치는 텍스트 숨기기 */
text-overflow: ellipsis; /* 넘칠 때 ... 표시 */
white-space: nowrap; /* 텍스트 줄바꿈 방지 */
width: 100%; /* 텍스트가 넘칠 수 있도록 적절한 너비 설정 */
}
img {
    width: 5vw;
    height: 8vh;
    border-radius: 1vw; /* border-radious -> border-radius로 수정 */
}

/* pagination */
.pagination {
    width: 50vw;
    position: relative;
    left: 43vw;
    display: flex;
    gap:0.3vw;
    }

    .searchResult {
    position:relative;
    left: 80vw;
    bottom:1vh;
    background-color: #f0f0f0;
    }
</style>
<body>
<div class="searchResult">
    <span class="'col'" th:text="'총 ' + ${totalPages * 5} + '건'"></span>
</div>

<div class="main-container">

    <div class="map-container">
        <div id="map"></div>
    </div>



    <div class="row-container">
        <div class="row" th:each="TourInfoDto: ${TourInfoDtoList}">
            <div class="img-container">
                <img src="/img/test.jpg">
            </div>

            <div class="rightinfo-container">
                <a th:href="@{/tourinfo/detail/{x}(x=${TourInfoDto.TourInfo.id}, q=${query})}">
                    <div class="rightinfo">
                        <span class="col">이름: </span>
                        <span class="Text" th:text="${TourInfoDto.TourInfo.title}">장금이</span></div>
                </a>
                <div class="rightinfo">
                    <span class="col">주소: </span>
                    <span class="Text" th:text="${TourInfoDto.TourInfo.address}">장금이</span>
                </div>
                <div class="rightinfo">
                    <span class="col">카테고리: </span>
                    <span class="Text" th:text="${TourInfoDto.TourInfo.category}">장금이</span>
                </div>
            </div>


            <div class="leftinfo-container">
                <div class="leftinfo">
                    <span class="col">이용시간: </span>
                    <span class="Text" th:text="${TourInfoDto.TourInfo.openTime}">11:00~21:00 (브레이크타임 15:00~17:00 / 라스트오더 19:30)</span>
                </div>
                <div class="leftinfo">
                    <span class="col">상세정보: </span>
                    <span class="Text" th:text="${TourInfoDto.TourInfo.detailInfo}">경기도 시흥의 지역 특산물 중의 하나가 바로 ‘연’이다.
    연은 수련과에 속하는 다년생 수생식물로 뿌리채소로는 드물게 다량의 비타민과 무기질을 함유하고 있어 최근 건강식 식품원료로 각광받고 있으나
    그 효능에 비해 다양한 조리방법이 개발되어 있지 않아 흔히 연하면 연근 반찬 이외엔 생각나는 것이 없는데, 산현동 연 요리 전문점 장금이를 찾으면
        그렇지 않음을 직접 확인할 수 있다. 흔치 않은 색다른 한정식을 원한다면 한 번쯤은 꼭 한 번 들러 연밥 정식과 연잎수육을 맛봐야 할 곳이다. </span>
                </div>
                <div class="leftinfo">
                    <span class="col">개요: </span>
                    <span class="Text" th:text="${TourInfoDto.TourInfo.summary}">...</span>
                </div>
            </div>
        </div>
    </div>


    <!-- pagination -->
    <ul class="pagination justify-content-center my-4">

        <!-- First Page Link -->
        <li class="page-item" th:if="${totalPages > 5}">
            <a th:if="${session.currentTourinfoPage == 1}" class="page-link">
                <i class="fa-solid fa-angle-double-left"></i>
            </a>

            <a th:if="${session.currentTourinfoPage > 1}" class="page-link" th:href="@{/tourinfo/list(p=1, c=${category}, a=${address}, k=${keyword}, sf=${sortField}, sd=${sortDirection})}">
                <i class="fa-solid fa-angle-double-left"></i>
            </a>
        </li>


        <!-- Previous Page Link -->
        <li class="page-item" th:if="${totalPages > 1 }">
            <a th:if="${session.currentTourinfoPage == 1}" class="page-link">
                <i class="fa-solid fa-less-than"></i>
            </a>

            <a th:if="${session.currentTourinfoPage > 1}" class="page-link" th:href="@{/tourinfo/list(p=${session.currentTourinfoPage - 1}, c=${category}, a=${address}, k=${keyword}, sf=${sortField}, sd=${sortDirection})}">
                <i class="fa-solid fa-less-than"></i>
            </a>
        </li>


        <!-- Page Number Links -->
        <th:block th:each="page : ${pageList}">
            <li class="page-item" th:classappend="${page == session.currentTourinfoPage} ? ' active' : ''">
                <a class="page-link"
                   th:href="@{/tourinfo/list(p=${page},c=${category},a=${address},k=${keyword},sf=${sortField},sd=${sortDirection})}">
                    [[${page}]]
                </a>
            </li>
        </th:block>

        <!-- Next Page Link -->
        <li class="page-item" th:if="${totalPages > 1}">
            <a th:if="${session.currentTourinfoPage == totalPages}" class="page-link">
                <i class="fa-solid fa-greater-than"></i>
            </a>
            <a th:if="${session.currentTourinfoPage < totalPages}" class="page-link" th:href="@{/tourinfo/list(p=${session.currentTourinfoPage + 1}, c=${category}, a=${address}, k=${keyword}, sf=${sortField}, sd=${sortDirection})}">
                <i class="fa-solid fa-greater-than"></i>
            </a>
        </li>

        <!-- Last Page Link -->
        <li class="page-item" th:if="${totalPages > 5}">

            <a th:if="${session.currentTourinfoPage == totalPages}" class="page-link">
                <i class="fa-solid fa-angle-double-right"></i>
            </a>
            <a th:if="${session.currentTourinfoPage < totalPages}" class="page-link" th:href="@{/tourinfo/list(p=${totalPages}, c=${category}, a=${address}, k=${keyword}, sf=${sortField}, sd=${sortDirection})}">
                <i class="fa-solid fa-angle-double-right"></i>
            </a>
        </li>
    </ul>

</div>


</body>
<!-- 네이버 지도 API JavaScript 파일 로드 -->
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=i7xm534ku0" type="text/javascript"></script>
<script th:inline="javascript">
    // 서버에서 전달된 pointDtoList를 JSON 형식으로 변환하여 JavaScript 배열로 사용
    const pointDtoList = /*[[${pointDtoList}]]*/ [];
    console.log(pointDtoList); // 배열이 잘 출력되는지 확인

    // map 객체를 전역으로 선언하여 다른 함수에서도 접근할 수 있도록 함
    let map;

// 원 생성 함수
function createCircle(center, radiusInMeters) {
    const circle = new naver.maps.Circle({
        center: new naver.maps.LatLng(center.lat, center.lng),
        radius: radiusInMeters,
        strokeColor: '#4169E1',
        strokeWeight: 2
    });

    // 원을 지도에 추가
    circle.setMap(map);
    return circle;
}

// 지도 초기화 함수
function initMap() {
    const mapOptions = {
        zoom: 10,
        scaleControl: false,
        logoControl: false,
        mapDataControl: false,
        zoomControl: true,
        minZoom: 6,
    };

    map = new naver.maps.Map('map', mapOptions);

    const centerPoint = calculateCenterPoint(pointDtoList);
    const maxDistance = calculateMaxDistance(centerPoint, pointDtoList);
    const radiusInMeters = maxDistance * 1000 + 500;



    map.setCenter(new naver.maps.LatLng(centerPoint.lat, centerPoint.lng));
    map.setZoom(calculateZoomLevelFromRadius(maxDistance));

    // 지도에 마커 추가
    pointDtoList.forEach(createMarker);

    // 원 생성
    createCircle(centerPoint, radiusInMeters);
}

    // 중앙점을 계산하는 함수
    function calculateCenterPoint(locations) {
        let sumLat = 0;
        let sumLng = 0;

        locations.forEach(location => {
            sumLat += location.lat;
            sumLng += location.lng;
        });

        const centerLat = sumLat / locations.length;
        const centerLng = sumLng / locations.length;

        return { lat: centerLat, lng: centerLng };
    }

    // 중심점에서 가장 먼 위치까지의 거리 계산 함수
    function calculateMaxDistance(center, locations) {
        let maxDistance = 0;

        locations.forEach(location => {
            const distance = calculateDistance(center.lat, center.lng, location.lat, location.lng);
            maxDistance = Math.max(maxDistance, distance);
        });

        return maxDistance; // 킬로미터 단위
    }

    // 두 지점 사이의 거리 계산 함수 (Haversine 공식을 사용)
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // 지구의 반지름 (킬로미터)
        const dLat = toRadians(lat2 - lat1);
        const dLng = toRadians(lng2 - lng1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // 킬로미터 단위
    }

    // 도 단위로 변환하는 함수
    function toRadians(degrees) {
        return degrees * (Math.PI / 180);
    }

    function calculateZoomLevelFromRadius(radiusInKm) {
    // 반지름 (킬로미터)을 미터로 변환
    const radiusInMeters = radiusInKm * 1000;

    // 지도 크기 가져오기
    const mapSize = map.getSize(); // { width, height }
    const viewportWidth = mapSize.width; // 픽셀 단위 너비
    const viewportHeight = mapSize.height; // 픽셀 단위 높이

    // 화면 대각선 길이를 계산 (픽셀 단위)
    const viewportDiagonal = Math.sqrt(viewportWidth ** 2 + viewportHeight ** 2);

    // 대각선 길이에 따른 줌 레벨 계산
    // 대략적으로 1줌 레벨 차이는 2배 크기의 범위를 표시함
    const zoomLevel = Math.floor(16 - Math.log2((radiusInMeters * 2) / viewportDiagonal));

    // 최소 및 최대 줌 레벨 제한
    return Math.min(Math.max(zoomLevel, 6), 16); // 6~16 사이의 값으로 제한
}

    // 마커 생성 함수
    function createMarker(point) {
        const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(point.lat, point.lng),
            map: map,
        });

        // 마커 클릭 시 이벤트 처리
        naver.maps.Event.addListener(marker, 'click', () => {
            const spanTextList = document.querySelectorAll(".Text");
            const matchingSpanText = Array.from(spanTextList).find(Text => {
                return Text.textContent.trim() === point.title;
            });

            if (matchingSpanText) {
                const activeRow = document.querySelector('.row.clicked');
                if (activeRow) activeRow.classList.remove('clicked');

                const matchingRow = matchingSpanText.closest('.row');
                if (activeRow !== matchingRow && matchingRow) matchingRow.classList.add("clicked");
            } else {
                console.log("No matching row found.");
            }
        });

        // 마커 정보창 표시 이벤트
        naver.maps.Event.addListener(marker, 'mouseover', () => showInfoWindow(marker, point));
        naver.maps.Event.addListener(marker, 'mouseout', () => map.closeInfoWindow());
    }

    // 인포윈도우 표시 함수
    function showInfoWindow(marker, point) {
        const infoWindow = new naver.maps.InfoWindow({
            content: `
                <div style="
                    width: 200px;
                    text-align: center;
                    padding: 15px;
                    border-radius: 8px;
                    background-color: #fff;
                    border: 1px solid #ddd;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    font-family: 'Arial', sans-serif;
                    font-size: 14px;
                    color: #333;
                    line-height: 1.5;
                ">
                    <strong style="font-size: 16px; color: #333;">${point.title || 'Untitled'}</strong>
                </div>
            `,
        });
        infoWindow.open(map, marker);
    }

    // 지도 로드 후 initMap 함수 실행
    window.onload = initMap;
</script>


</html>

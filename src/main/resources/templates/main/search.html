<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="/css/body.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link href="/css/search.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <script src="/js/tourList.js" defer></script>
    <title>Bootstrap demo</title>
</head>
<body>


<div th:insert="~{fragments/header :: header}"></div>


<div class="main-container">

    <div class="map-container">
        <div id="map"></div>
    </div>


    <div class="search-row-container">
        <div class="sort-container">
            <div class="sort-options">
                <label for="sortBy">정렬 :</label>
                <select id="sortBy" class="sort-select">
                    <option value="location">위치</option>
                    <option value="name">이름</option>
                </select>
            </div>
            <div class="sort-buttons">
                <button id="sortAsc" class="sort-button">내림차순</button>
                <button id="sortDesc" class="sort-button">오름차순</button>
            </div>
            <!-- Reset Button -->
            <button id="resetButton" class="reset-button">초기화</button>
        </div>

        <div class="scroll-container">
                <div class="search-item" th:each="TourInfoDto: ${TourInfoDtoList}">
                    <div class="img-container">
                        <img class="searchResultImg" src="/img/test.jpg">
                    </div>

                <div class="rightinfo-container">
                    <a th:href="@{/tour/detail/{tourId}(tourId=${TourInfoDto.TourInfo.id})}">
                        <div class="rightinfo">
                            <span class="col">이름: </span>
                            <span class="Text" style="color:#0D6EFD" th:text="${TourInfoDto.TourInfo.title}">장금이</span>
                        </div>
                    </a>
                    <div class="rightinfo">
                        <span class="col">주소: </span>
                        <span class="Text" th:if="${#strings.isEmpty(TourInfoDto.tourInfo.address)}">주소 없음</span>
                        <span class="Text" th:if="${!#strings.isEmpty(TourInfoDto.tourInfo.address)}" th:text="${TourInfoDto.tourInfo.address}"></span>
                    </div>
                    <div class="rightinfo">
                        <span class="col">카테고리: </span>
                        <span class="Text" th:text="${TourInfoDto.TourInfo.category}">장금이</span>
                    </div>
                </div>


                <div class="leftinfo-container">
                    <div class="leftinfo">
                        <span class="col">이용시간: </span>
                        <span class="Text" th:text="${TourInfoDto.TourInfo.openTime}">11:00~21:00 (브레이크타임 15:00~17:00 / 라스트오더 19:30)</span>
                    </div>
                    <div class="leftinfo">
                        <span class="col">상세정보: </span>
                        <span class="Text" th:if="${#strings.isEmpty(TourInfoDto.tourInfo.detailInfo)}">상세개요 없음</span>
                        <span class="Text" th:if="${!#strings.isEmpty(TourInfoDto.tourInfo.detailInfo)}" th:text="${TourInfoDto.tourInfo.detailInfo}"></span>
                    </div>
                    <div class="leftinfo">
                        <span class="col">개요: </span>
                        <span class="Text" th:text="${TourInfoDto.TourInfo.summary}">...</span>
                    </div>
                </div>
            </div>
            </div>

        <!-- pagination -->
        <ul class="pagination justify-content-center my-4">

            <!-- First Page Link -->
            <li class="page-item" th:if="${totalPages > 5}">
                <a class="page-link" th:if="${session.currentTourinfoPage == 1}">
                    <img src="/img/firstprevious.png" style="width:1vw;">
                </a>

                <a class="page-link" th:href="@{/tour/list(p=1, c=${category}, a=${address}, k=${keyword}, sf=${sortField}, sd=${sortDirection})}"
                   th:if="${session.currentTourinfoPage > 1}">
                    <img src="/img/firstprevious.png" style="width:1vw;">
                </a>
            </li>


            <!-- Previous Page Link -->
            <li class="page-item" th:if="${totalPages > 1 }">
                <a class="page-link" th:if="${session.currentTourinfoPage == 1}">
                    <img src="/img/previous.png" style="width:1vw;">
                </a>

                <a class="page-link" th:href="@{/tour/list(p=${session.currentTourinfoPage - 1}, c=${category}, a=${address}, k=${keyword}, sf=${sortField}, sd=${sortDirection})}"
                   th:if="${session.currentTourinfoPage > 1}">
                    <img src="/img/previous.png" style="width:1vw;">
                </a>
            </li>


            <!-- Page Number Links -->
            <th:block th:each="page : ${pageList}">
                <li class="page-item" th:classappend="${page == session.currentTourinfoPage} ? ' active' : ''">
                    <a class="page-link"
                       th:href="@{/tour/list(p=${page},c=${category},a=${address},k=${keyword},sf=${sortField},sd=${sortDirection})}">
                        [[${page}]]
                    </a>
                </li>
            </th:block>

            <!-- Next Page Link -->
            <li class="page-item" th:if="${totalPages > 1}">
                <a class="page-link" th:if="${session.currentTourinfoPage == totalPages}">
                    <img src="/img/next.png" style="width:1vw;">
                </a>
                <a class="page-link" th:href="@{/tour/list(p=${session.currentTourinfoPage + 1}, c=${category}, a=${address}, k=${keyword}, sf=${sortField}, sd=${sortDirection})}"
                   th:if="${session.currentTourinfoPage < totalPages}">
                    <img src="/img/next.png" style="width:1vw;">
                </a>
            </li>

            <!-- Last Page Link -->
            <li class="page-item" th:if="${totalPages > 5}">

                <a class="page-link" th:if="${session.currentTourinfoPage == totalPages}">
                    <img src="/img/lastnext.png" style="width:1vw;">
                </a>
                <a class="page-link" th:href="@{/tour/list(p=${totalPages}, c=${category}, a=${address}, k=${keyword}, sf=${sortField}, sd=${sortDirection})}"
                   th:if="${session.currentTourinfoPage < totalPages}">
                    <img src="/img/lastnext.png" style="width:1vw;">
                </a>
            </li>
        </ul>
    </div>

</div>


<div th:insert="~{fragments/footer :: footer}"></div>

</body>
<!-- 네이버 지도 API JavaScript 파일 로드 -->
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=i7xm534ku0" type="text/javascript"></script>
<script th:inline="javascript">
    // 서버에서 전달된 pointDtoList를 JSON 형식으로 변환하여 JavaScript 배열로 사용
    const pointDtoList = /*[[${pointDtoList}]]*/ [];
    console.log(pointDtoList); // 배열이 잘 출력되는지 확인

    // map 객체를 전역으로 선언하여 다른 함수에서도 접근할 수 있도록 함
    let map;

// 원 생성 함수
function createCircle(center, radiusInMeters) {
    const circle = new naver.maps.Circle({
        center: new naver.maps.LatLng(center.lat, center.lng),
        radius: radiusInMeters,
        strokeColor: '#4169E1',
        strokeWeight: 2
    });

    // 원을 지도에 추가
    circle.setMap(map);
    return circle;
}

// 지도 초기화 함수
function initMap() {
    const mapOptions = {
        zoom: 10,
        scaleControl: false,
        logoControl: false,
        mapDataControl: false,
        zoomControl: true,
        minZoom: 6,
    };

    map = new naver.maps.Map('map', mapOptions);

    const centerPoint = calculateCenterPoint(pointDtoList);
    const maxDistance = calculateMaxDistance(centerPoint, pointDtoList);
    const radiusInMeters = maxDistance * 1000 + 500;



    map.setCenter(new naver.maps.LatLng(centerPoint.lat, centerPoint.lng));
    map.setZoom(calculateZoomLevelFromRadius(maxDistance));

    // 지도에 마커 추가
    pointDtoList.forEach(createMarker);

    // 원 생성
    createCircle(centerPoint, radiusInMeters);
}

    // 중앙점을 계산하는 함수
    function calculateCenterPoint(locations) {
        let sumLat = 0;
        let sumLng = 0;

        locations.forEach(location => {
            sumLat += location.lat;
            sumLng += location.lng;
        });

        const centerLat = sumLat / locations.length;
        const centerLng = sumLng / locations.length;

        return { lat: centerLat, lng: centerLng };
    }

    // 중심점에서 가장 먼 위치까지의 거리 계산 함수
    function calculateMaxDistance(center, locations) {
        let maxDistance = 0;

        locations.forEach(location => {
            const distance = calculateDistance(center.lat, center.lng, location.lat, location.lng);
            maxDistance = Math.max(maxDistance, distance);
        });

        return maxDistance; // 킬로미터 단위
    }

    // 두 지점 사이의 거리 계산 함수 (Haversine 공식을 사용)
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // 지구의 반지름 (킬로미터)
        const dLat = toRadians(lat2 - lat1);
        const dLng = toRadians(lng2 - lng1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // 킬로미터 단위
    }

    // 도 단위로 변환하는 함수
    function toRadians(degrees) {
        return degrees * (Math.PI / 180);
    }

    function calculateZoomLevelFromRadius(radiusInKm) {
    // 반지름 (킬로미터)을 미터로 변환
    const radiusInMeters = radiusInKm * 1000;

    // 지도 크기 가져오기
    const mapSize = map.getSize(); // { width, height }
    const viewportWidth = mapSize.width; // 픽셀 단위 너비
    const viewportHeight = mapSize.height; // 픽셀 단위 높이

    // 화면 대각선 길이를 계산 (픽셀 단위)
    const viewportDiagonal = Math.sqrt(viewportWidth ** 2 + viewportHeight ** 2);

    // 대각선 길이에 따른 줌 레벨 계산
    // 대략적으로 1줌 레벨 차이는 2배 크기의 범위를 표시함
    const zoomLevel = Math.floor(16 - Math.log2((radiusInMeters * 2) / viewportDiagonal));

    // 최소 및 최대 줌 레벨 제한
    return Math.min(Math.max(zoomLevel, 6), 16); // 6~16 사이의 값으로 제한
}

    // 마커 생성 함수
    function createMarker(point) {
        const marker = new naver.maps.Marker({
            position: new naver.maps.LatLng(point.lat, point.lng),
            map: map,
        });

        // 마커 클릭 시 이벤트 처리
        naver.maps.Event.addListener(marker, 'click', () => {
            const spanTextList = document.querySelectorAll(".Text");
            const matchingSpanText = Array.from(spanTextList).find(Text => {
                return Text.textContent.trim() === point.title;
            });

            if (matchingSpanText) {
                const activeRow = document.querySelector('.search-row.clicked');
                if (activeRow) activeRow.classList.remove('clicked');

                const matchingRow = matchingSpanText.closest('.search-row');
                if (activeRow !== matchingRow && matchingRow) matchingRow.classList.add("clicked");
            } else {
                console.log("No matching row found.");
            }
        });

        // 마커 정보창 표시 이벤트
        naver.maps.Event.addListener(marker, 'mouseover', () => showInfoWindow(marker, point));
        naver.maps.Event.addListener(marker, 'mouseout', () => map.closeInfoWindow());
    }

    // 인포윈도우 표시 함수
    function showInfoWindow(marker, point) {
        const infoWindow = new naver.maps.InfoWindow({
            content: `
                <div style="
                    width: 200px;
                    text-align: center;
                    padding: 15px;
                    border-radius: 8px;
                    background-color: #fff;
                    border: 1px solid #ddd;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                    font-family: 'Arial', sans-serif;
                    font-size: 14px;
                    color: #333;
                    line-height: 1.5;
                ">
                    <strong style="font-size: 16px; color: #333;">${point.title || 'Untitled'}</strong>
                </div>
            `,
        });
        infoWindow.open(map, marker);
    }

    // 지도 로드 후 initMap 함수 실행
    window.onload = initMap;
</script>

</html>
